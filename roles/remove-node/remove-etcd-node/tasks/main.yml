---
- name: Remove member from etcd cluster
  environment:
    ETCDCTL_API: "3"
    ETCDCTL_CERT: "{{ etcd_cert_dir }}/admin-{{ groups['etcd'] | first }}.pem"
    ETCDCTL_KEY: "{{ etcd_cert_dir }}/admin-{{ groups['etcd'] | first }}-key.pem"
    ETCDCTL_CACERT: "{{ etcd_cert_dir }}/ca.pem"
    ETCDCTL_ENDPOINTS: "https://127.0.0.1:2379"
  delegate_to: "{{ groups['etcd'] | first }}"
  block:
    - name: Lookup members infos
      command: "{{ bin_dir }}/etcdctl member list"
      register: etcd_members
      changed_when: false
      check_mode: false
      tags:
        - facts
    - name: Remove member from cluster
      command:
        argv:
          - "{{ bin_dir }}/etcdctl"
          - member
          - remove
          - "{{ ((etcd_members.stdout_lines | select('contains', '//' + main_access_ip + ':'))[0] | split(','))[0] }}"
      register: etcd_removal_output
      changed_when: "'Removed member' in etcd_removal_output.stdout"

- name: Remove member from etcd-events cluster
  environment:
    ETCDCTL_API: "3"
    ETCDCTL_CERT: "{{ etcd_cert_dir }}/admin-{{ groups['etcd'] | first }}.pem"
    ETCDCTL_KEY: "{{ etcd_cert_dir }}/admin-{{ groups['etcd'] | first }}-key.pem"
    ETCDCTL_CACERT: "{{ etcd_cert_dir }}/ca.pem"
    ETCDCTL_ENDPOINTS: "https://127.0.0.1:2383"
  delegate_to: "{{ groups['etcd'] | first }}"
  when: etcd_events_cluster_setup
  block:
  - name: Lookup members infos
    command: "{{ bin_dir }}/etcdctl member list"
    register: etcd_members
    changed_when: false
    check_mode: false
    tags:
    - facts
  - name: Remove member from cluster
    command:
      argv:
      - "{{ bin_dir }}/etcdctl"
      - member
      - remove
      - "{{ ((etcd_members.stdout_lines | select('contains', '//' + main_access_ip + ':'))[0] | split(','))[0] }}"
    register: etcd_removal_output
    changed_when: "'Removed member' in etcd_removal_output.stdout"
