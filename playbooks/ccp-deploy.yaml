- hosts: kube-master

  pre_tasks:

    - name: Rsync CCP configs
      synchronize:
        src: ../ccp/
        dest: /root/ccp/

  tasks:
    - name: Label nodes
      shell: ./label-nodes.sh
      args:
        chdir: /root/ccp
      run_once: true

    - name: Get namespaces
      shell: kubectl get namespace
      register: get_ns
      run_once: true

    - name: Deploy CCP
      shell: "mcp-microservices --config-file=/root/ccp/ccp.conf deploy &> /var/log/ccp-deploy.log"
      args:
        chdir: /root/ccp
      run_once: true
      when: get_ns.stdout.find('openstack') == -1
