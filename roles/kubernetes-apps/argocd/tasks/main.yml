---
- name: Kubernetes Apps | Install ArgoCD
  become: true
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  vars:
    k8s_namespace: "{{ argocd_namespace }}"
    ns_object:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ argocd_namespace }}"
        labels:
          app: argocd
  command:
    cmd: "{{ kubectl_apply_stdin }}"
    stdin: "{{[
              ns_object ,
              lookup('file', install_source_localhost + '/' + downloads.argocd_install.dest) | from_yaml
              ]
              | to_json }}"

# https://github.com/argoproj/argo-cd/blob/master/docs/faq.md#i-forgot-the-admin-password-how-do-i-reset-it
- name: Kubernetes Apps | Set ArgoCD custom admin password
  become: true
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  vars:
    password_patch:
      stringData:
        'admin.password': "{{ argocd_admin_password | password_hash('bcrypt') }}"
        'admin.passwordMtime': "{{ lookup('pipe', 'date +%FT%T%Z') }}"
  command:
    cmd: "{{ kubectl }} -n {{ argocd_namespace }} patch secret argocd-secret --patch-file=/dev/stdin"
    stdin: "{{ password_patch | to_json }}"
  when:
    - argocd_admin_password is defined
