---
- name: Prepare | facts and download
  hosts: all:localhost
  gather_facts: false
  become: true
  vars:
    kube_network_plugin: cni
  pre_tasks:
    - name: Gather facts on localhost
      setup:
        gather_subset: '!all'
        filter: ansible_*
      when: inventory_hostname == 'localhost'
  roles:
    - role: dynamic_groups
    - role: network_facts
    - role: bootstrap_os
      when: inventory_hostname != 'localhost'
    - role: download/file

- name: Prepare
  hosts: all
  gather_facts: false
  become: true
  vars:
    ignore_assert_errors: true
    kube_network_plugin: cni
  roles:
    - role: kubespray_defaults
    - role: kubernetes/preinstall
    - role: network_plugin/cni
  tasks:
    - name: Create /etc/cni/net.d directory
      file:
        path: /etc/cni/net.d
        state: directory
        owner: root
        mode: "0755"
    - name: Config bridge host-local CNI
      copy:
        src: "10-mynet.conf"
        dest: "/etc/cni/net.d/"
        owner: root
        mode: "0644"
