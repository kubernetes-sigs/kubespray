---
- name: Add proxy to RHEL subscription-manager if http_proxy is defined
  command: /sbin/subscription-manager config --server.proxy_hostname={{ http_proxy | regex_replace(':\d+$') | regex_replace('^.*://') }} --server.proxy_port={{ http_proxy | regex_replace('^.*:') }}
  become: true
  when:
    - not skip_http_proxy_on_os_packages
    - http_proxy is defined

- name: Check RHEL subscription-manager status
  command: /sbin/subscription-manager status
  register: rh_subscription_status
  changed_when: "rh_subscription_status.rc != 0"
  ignore_errors: true  # noqa ignore-errors
  timeout: "{{ rh_subscription_check_timeout }}"
  become: true

- name: RHEL subscription Organization ID/Activation Key registration
  community.general.redhat_subscription:
    state: present
    org_id: "{{ rh_subscription_org_id }}"
    activationkey: "{{ rh_subscription_activation_key }}"
    force_register: true
  register: rh_subscription_attach
  become: true
  when:
    - rh_subscription_org_id is defined
    - rh_subscription_status.changed

# this task has no_log set to prevent logging security sensitive information such as subscription passwords
- name: RHEL subscription Username/Password registration
  community.general.redhat_subscription:
    state: present
    username: "{{ rh_subscription_username }}"
    password: "{{ rh_subscription_password }}"
    auto_attach: true
    force_register: true
    syspurpose:
      usage: "{{ rh_subscription_usage }}"
      role: "{{ rh_subscription_role }}"
      service_level_agreement: "{{ rh_subscription_sla }}"
      sync: true
  register: rh_subscription_attach
  become: true
  no_log: "{{ not (unsafe_show_logs | bool) }}"
  when:
    - rh_subscription_username is defined
    - rh_subscription_status.changed

- name: RHEL auto-attach subscription
  command: /sbin/subscription-manager attach --auto
  become: true
  when: rh_subscription_attach is changed # noqa no-handler
