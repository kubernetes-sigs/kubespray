---
- name: Cilium | Ensure BPFFS mounted
  ansible.posix.mount:
    fstype: bpf
    path: /sys/fs/bpf
    src: bpffs
    state: mounted

- name: Cilium | Create Cilium certs directory
  file:
    dest: "{{ cilium_cert_dir }}"
    state: directory
    mode: "0750"
    owner: root
    group: root
  when:
    - cilium_identity_allocation_mode == "kvstore"

- name: Cilium | Link etcd certificates for cilium
  file:
    src: "{{ etcd_cert_dir }}/{{ item.s }}"
    dest: "{{ cilium_cert_dir }}/{{ item.d }}"
    mode: "0644"
    state: hard
    force: true
  loop:
    - {s: "{{ kube_etcd_cacert_file }}", d: "ca_cert.crt"}
    - {s: "{{ kube_etcd_cert_file }}", d: "cert.crt"}
    - {s: "{{ kube_etcd_key_file }}", d: "key.pem"}
  when:
    - cilium_identity_allocation_mode == "kvstore"

- name: Cilium | Enable portmap addon
  template:
    src: 000-cilium-portmap.conflist.j2
    dest: /etc/cni/net.d/000-cilium-portmap.conflist
    mode: "0644"
  when: cilium_enable_portmap

- name: Cilium | Render values
  template:
    src: values.yaml.j2
    dest: "{{ kube_config_dir }}/cilium-values.yaml"
    mode: "0644"
  when:
    - inventory_hostname == groups['kube_control_plane'][0]

# Use the rendered values file as the default values
# and recursively merge cilium_chart_values as override values.
- name: Cilium | Patch values
  when:
    - inventory_hostname == groups['kube_control_plane'][0]
    - cilium_chart_values != None
  block:
    - name: Cilium | Read rendered values
      slurp:
        src: "{{ kube_config_dir }}/cilium-values.yaml"
      register: cilium_values_file

    - name: Cilium | Patch rendered values
      copy:
        content: >
          {{
            cilium_values_file.content | b64decode | from_yaml
            | combine(cilium_chart_values | default({}), recursive=True)
            | cilium_values | to_nice_yaml(indent=2) | indent(2)
          }}
        dest: "{{ kube_config_dir }}/cilium-values.yaml"
        mode: "0644"

- name: Cilium | Copy extra values
  copy:
    content: "{{ cilium_extra_values | to_nice_yaml(indent=2) }}"
    dest: "{{ kube_config_dir }}/cilium-extra-values.yaml"
    mode: "0644"
  when:
    - inventory_hostname == groups['kube_control_plane'][0]

- name: Cilium | Copy Ciliumcli binary from download dir
  copy:
    src: "{{ local_release_dir }}/cilium"
    dest: "{{ bin_dir }}/cilium"
    mode: "0755"
    remote_src: true
