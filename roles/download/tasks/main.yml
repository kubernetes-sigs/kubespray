---
- name: Download | Prepare working directories and variables
  import_tasks: prep_download.yml
  when:
    - not skip_downloads | default(false)
  tags:
    - download
    - upload

- name: Download | Get kubeadm binary and list of required images
  include_tasks: prep_kubeadm_images.yml
  when:
    - not skip_downloads | default(false)
    - ('kube_control_plane' in group_names)
  tags:
    - download
    - upload

- name: Download | Download files / images
  include_tasks: download_container.yml
  loop: "{{ downloads | combine(kubeadm_images) | dict2items
          | selectattr('value.container', 'defined')
          | selectattr('value.container')
          | selectattr('value.enabled') }}"
  vars:
    download: "{{ download_defaults | combine(item.value) }}"
  when:
    - not skip_downloads | default(false)
    - download.enabled
    - (download_run_once and inventory_hostname == download_delegate) or (group_names | intersect(download.groups) | length)
