---
- name: Create temp file path
  tempfile:
    state: file
    suffix: .yml
  register: temp_lima_file

- name: Render template
  ansible.builtin.template:
    src: lima.yml.j2
    dest: "{{ temp_lima_file.path }}"
    mode: "0644"

- name: Create the VMs
  command: limactl create --name={{ item }} {{ temp_lima_file.path }} -y
  with_sequence: start=1 end={{ instance_count }} format={{ instance_prefix }}-%d

- name: Start the VMs
  command: limactl start {{ item }}
  with_sequence: start=1 end={{ instance_count }} format={{ instance_prefix }}-%d
