---
- name: Add proxy to yum.conf or dnf.conf if http_proxy is defined
  community.general.ini_file:
    path: "/etc/dnf/dnf.conf"
    section: main
    option: proxy
    value: "{{ http_proxy | default(omit) }}"
    state: "{{ http_proxy | default(False) | ternary('present', 'absent') }}"
    no_extra_spaces: true
    mode: "0644"
  become: true
  when:
    - not skip_http_proxy_on_os_packages
    - ansible_pkg_mgr == 'dnf'

- name: Distribution family specific package config
  include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "os_family/{{ ansible_os_family }}.yml"
      skip: true

- name: Distribution specific package config
  include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "os/{{ ansible_distribution }}.yml"
      skip: true

- name: Update package management cache (zypper) - SUSE
  command: zypper -n --gpg-auto-import-keys ref
  register: make_cache_output
  until: make_cache_output is succeeded
  retries: 4
  delay: "{{ retry_stagger | random + 3 }}"
  when:
    - ansible_pkg_mgr == 'zypper'
  tags: bootstrap_os

# Remove this after ansible-core >= 2.19.0
# See https://github.com/kubernetes-sigs/kubespray/pull/12138#issuecomment-3019304574
- name: Install python3-libdnf5 on Fedora >= 41
  raw: >
    dnf install --assumeyes python3-libdnf5
  become: true
  retries: "{{ pkg_install_retries }}"
  when:
    - ansible_distribution == "Fedora"
    - ansible_distribution_major_version | int >= 41

- name: Manage packages
  package:
    name: "{{ item.packages | dict2items | selectattr('value', 'ansible.builtin.all') | map(attribute='key') }}"
    state: "{{ item.state }}"
    update_cache: "{{ true if ansible_pkg_mgr in ['zypper', 'apt', 'dnf'] else omit }}"
    cache_valid_time: "{{ 86400 if ansible_pkg_mgr == 'apt' else omit }}" # 24h
  register: pkgs_task_result
  until: pkgs_task_result is succeeded
  retries: "{{ pkg_install_retries }}"
  delay: "{{ retry_stagger | random + 3 }}"
  when: not (ansible_os_family in ["Flatcar", "Flatcar Container Linux by Kinvolk"] or is_fedora_coreos)
  loop:
    - { packages: "{{ pkgs_to_remove }}", state: "absent", action_label: "remove" }
    - { packages: "{{ pkgs }}", state: "present", action_label: "install" }
  loop_control:
    label: "{{ item.action_label }}"
  tags:
    - bootstrap_os
  timeout: "{{ pkg_install_timeout }}"
