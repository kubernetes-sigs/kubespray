---
- name: Kubernetes Apps | Install yq binary
  copy:
    src: "{{ local_release_dir + downloads.yq.dest }}"
    dest: "{{ bin_dir }}/yq"
    mode: "0755"
    remote_src: "{{ download_delegate == inventory_hostname }}"

- name: Kubernetes Apps | Install ArgoCD
  become: true
  vars:
    namespace: "{{ argocd_namespace }}"
  command:
    cmd: "{{ kubectl_apply_stdin }}"
    stdin: "{{[
              lookup('pipe', 'kubectl create --dry-run=client -o yaml ns ' + argocd_namespace),
              lookup('file', downloads.argocd_install.dest)
              ]
              | join('---\n') }}"

# https://github.com/argoproj/argo-cd/blob/master/docs/faq.md#i-forgot-the-admin-password-how-do-i-reset-it
- name: Kubernetes Apps | Set ArgoCD custom admin password
  become: true
  vars:
    password_patch:
      stringData:
        'admin.password': "{{ argocd_admin_password | password_hash('bcrypt') }}"
        'admin.passwordMtime': "{{ lookup('pipe', 'date +%FT%T%Z') }}"
  command:
    cmd: "{{ kubectl }} -n {{ argocd_namespace }} patch secret argocd-secret --patch-file=/dev/stdin"
    stdin: "{{ password_patch | to_json }}"
  when:
    - argocd_admin_password is defined
