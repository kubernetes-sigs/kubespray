---
- name: container_download | Make download decision if pull is required by tag or sha256
  import_tasks: set_docker_image_facts.yml
  delegate_to: "{{ download_delegate if download_run_once or omit }}"
  delegate_facts: yes
  run_once: "{{ download_run_once }}"
  when:
    - download.enabled
    - download.container
  tags:
    - facts

- debug:
    msg:
      - "pull_args: {{ pull_args }}"

- name: container_download | Download containers if pull is required or told to always pull (delegate)
  command: "{{ docker_bin_dir }}/docker pull {{ pull_args }}"
  become: true
  register: pull_task_result
  until: pull_task_result is succeeded
  delegate_to: "{{ download_delegate | default(inventory_hostname) }}"
  delegate_facts: yes
  run_once: "{{ download_run_once }}"
  retries: 4
  delay: "{{ retry_stagger | random + 3 }}"
  when:
    - download.enabled
    - download.container
    - pull_required|default(download_always_pull)
    - download_run_once or (group_names | intersect(download.groups) | length)
  tags:
    - upload
    - upgrade

