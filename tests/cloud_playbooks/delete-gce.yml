---
- hosts: localhost
  become: false
  gather_facts: no
  vars:
    cloud_machine_type: f1-micro

  tasks:
    - name: replace_test_id
      set_fact:
        test_name: "{{test_id |regex_replace('\\.', '-')}}"

    - name: delete gce instances
      gce:
        instance_names: "k8s-{{test_name}}-1,k8s-{{test_name}}-2,k8s-{{test_name}}-3"
        machine_type: "{{ cloud_machine_type }}"
        image: "{{ cloud_image }}"
        service_account_email: "{{ gce_service_account_email }}"
        pem_file: "{{ gce_pem_file | default(omit)}}"
        credentials_file: "{{gce_credentials_file | default(omit)}}"
        project_id: "{{ gce_project_id }}"
        zone: "{{cloud_region | default('europe-west1-b')}}"
        metadata: '{"test_id": "{{test_id}}", "network": "{{kube_network_plugin}}"}'
        state: 'absent'
      register: gce
