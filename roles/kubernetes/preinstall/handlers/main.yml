- name: Preinstall | restart network
  command: /bin/true
  notify:
    - Preinstall | reload network
    - Preinstall | update resolvconf
  when: ansible_os_family != "CoreOS"

- name: Preinstall | reload network
  service:
    name: >-
      {% if ansible_os_family == "RedHat" -%}
      network
      {%- elif ansible_os_family == "Debian" -%}
      networking
      {%- endif %}
    state: restarted
  when: ansible_os_family != "RedHat" and ansible_os_family != "CoreOS"

- name: Preinstall | update resolvconf
  command: /bin/true
  notify:
    - Preinstall | reload resolvconf
    - Preinstall | reload kubelet
  when: ansible_os_family != "CoreOS"

- name: Preinstall | update resolvconf for CoreOS
  command: /bin/true
  notify:
    - Preinstall | apply resolvconf cloud-init
    - Preinstall | reload kubelet
  when: ansible_os_family == "CoreOS"

- name: Preinstall | reload resolvconf
  command: /sbin/resolvconf -u
  ignore_errors: true

- name: Preinstall | apply resolvconf cloud-init
  command: /usr/bin/coreos-cloudinit --from-file {{ resolveconf_cloud_init_conf }}
  when: ansible_os_family == "CoreOS"

- name: Preinstall | reload kubelet
  service:
    name: kubelet
    state: restarted
  when: "{{ inventory_hostname in groups['kube-master'] and not dns_early|bool }}"
