---
- name: Generate etcd PKI
  import_role:
    name: etcd/certificates
  when: > # nodes using etcd directly or control plane
    (kube_network_plugin == "calico" and calico_datastore == "etcd") or
    kube_network_plugin in ["flannel", "cilium"] or
    cilium_deploy_additionally or
    'kube_control_plane' in group_names or
    'etcd' in group_names

- name: Install etcdctl and etcdutl binary
  import_role:
    name: etcdctl_etcdutl
  tags:
    - etcdctl
    - etcdutl
    - upgrade
  when:
    - ('etcd' in group_names)
    - etcd_cluster_setup

- name: Install etcd
  include_tasks: "install_{{ etcd_deployment_type }}.yml"
  when: ('etcd' in group_names)
  tags:
    - upgrade

- name: Configure etcd
  include_tasks: configure.yml
  when: ('etcd' in group_names)

- name: Refresh etcd config
  include_tasks: refresh_config.yml
  when: ('etcd' in group_names)

- name: Restart etcd if certs changed
  command: /bin/true
  notify: Restart etcd
  when:
    - ('etcd' in group_names)
    - etcd_cluster_setup
    - etcd_secret_changed | default(false)

- name: Restart etcd-events if certs changed
  command: /bin/true
  notify: Restart etcd
  when:
    - ('etcd' in group_names)
    - etcd_events_cluster_setup
    - etcd_secret_changed | default(false)

# After etcd cluster is assembled, make sure that
# initial state of the cluster is in `existing`
# state instead of `new`.
- name: Refresh etcd config again for idempotency
  include_tasks: refresh_config.yml
  when: ('etcd' in group_names)
